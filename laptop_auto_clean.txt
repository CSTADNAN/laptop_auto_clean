# ============================================
# Laptop Auto Maintenance - One Click Setup
# рж╕ржм ржХрж┐ржЫрзБ ржЕржЯрзЛржорзЗржЯрж┐ржХрзНржпрж╛рж▓рж┐ рж╕рзЗржЯржЖржк рж╣ржмрзЗ
# ============================================

# Administrator ржЕржзрж┐ржХрж╛рж░ ржЪрзЗржХ ржУ ржЕржЯрзЛ рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯ
if (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Host "Administrator ржЕржзрж┐ржХрж╛рж░ ржжрж░ржХрж╛рж░ред ржЕржЯрзЛ рж╕рзНржЯрж╛рж░рзНржЯ рж╣ржЪрзНржЫрзЗ..." -ForegroundColor Yellow
    Start-Process powershell.exe "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`"" -Verb RunAs
    exit
}

# ===== рж╕рзЗржЯржЖржк рж╢рзБрж░рзБ =====
Write-Host "тХФтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХЧ" -ForegroundColor Cyan
Write-Host "тХС  Laptop Auto Maintenance Setup        тХС" -ForegroundColor Cyan
Write-Host "тХС  рж╕ржм ржХрж┐ржЫрзБ ржЕржЯрзЛржорзЗржЯрж┐ржХрзНржпрж╛рж▓рж┐ рж╣ржмрзЗ           тХС" -ForegroundColor Cyan
Write-Host "тХЪтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХЭ" -ForegroundColor Cyan
Write-Host ""

# Configuration
$ScriptPath = "$env:ProgramData\LaptopMaintenance"
$MainScript = "$ScriptPath\MaintenanceService.ps1"
$LogPath = "$env:USERPROFILE\Documents\LaptopMaintenance"
$LogFile = "$LogPath\MaintenanceLog.txt"
$CheckInterval = 1800 # рзйрзж ржорж┐ржирж┐ржЯ

# Step 1: ExecutionPolicy рж╕рзЗржЯ ржХрж░рж╛
Write-Host "[1/5] ExecutionPolicy рж╕рзЗржЯржЖржк ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..." -ForegroundColor Yellow
try {
    Set-ExecutionPolicy RemoteSigned -Scope LocalMachine -Force
    Write-Host "тЬУ ExecutionPolicy рж╕рзЗржЯ рж╣ржпрж╝рзЗржЫрзЗ" -ForegroundColor Green
} catch {
    Write-Host "тЪа ExecutionPolicy рж╕рзЗржЯ ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛" -ForegroundColor Red
}

# Step 2: ржлрзЛрж▓рзНржбрж╛рж░ рждрзИрж░рж┐
Write-Host "[2/5] ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ ржлрзЛрж▓рзНржбрж╛рж░ рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..." -ForegroundColor Yellow
if (!(Test-Path $ScriptPath)) {
    New-Item -ItemType Directory -Path $ScriptPath -Force | Out-Null
}
if (!(Test-Path $LogPath)) {
    New-Item -ItemType Directory -Path $LogPath -Force | Out-Null
}
Write-Host "тЬУ ржлрзЛрж▓рзНржбрж╛рж░ рждрзИрж░рж┐ рж╣ржпрж╝рзЗржЫрзЗ" -ForegroundColor Green

# Step 3: ржорзЗржЗржи рж╕рзНржХрзНрж░рж┐ржкрзНржЯ рждрзИрж░рж┐
Write-Host "[3/5] ржорзЗржЗржи рж╕рж╛рж░рзНржнрж┐рж╕ рж╕рзНржХрзНрж░рж┐ржкрзНржЯ рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..." -ForegroundColor Yellow

$ServiceScript = @'
# ===== Maintenance Service Script =====

$LogPath = "$env:USERPROFILE\Documents\LaptopMaintenance"
$LogFile = "$LogPath\MaintenanceLog.txt"
$CheckInterval = 1800

if (!(Test-Path $LogPath)) {
    New-Item -ItemType Directory -Path $LogPath -Force | Out-Null
}

function Write-Log {
    param([string]$Message)
    $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    try {
        "$Timestamp - $Message" | Out-File -FilePath $LogFile -Append -Encoding UTF8
    } catch {}
}

function Clear-JunkFiles {
    Write-Log "ржЬрж╛ржЩрзНржХ ржлрж╛ржЗрж▓ ржкрж░рж┐рж╖рзНржХрж╛рж░ рж╢рзБрж░рзБ..."
    
    $TempPaths = @(
        "$env:TEMP\*",
        "$env:WINDIR\Temp\*",
        "$env:LOCALAPPDATA\Temp\*",
        "$env:USERPROFILE\AppData\Local\Microsoft\Windows\INetCache\*",
        "$env:WINDIR\Prefetch\*"
    )
    
    foreach ($Path in $TempPaths) {
        try {
            Remove-Item -Path $Path -Recurse -Force -ErrorAction SilentlyContinue
        } catch {}
    }
    
    Write-Log "ржЬрж╛ржЩрзНржХ ржлрж╛ржЗрж▓ ржкрж░рж┐рж╖рзНржХрж╛рж░ рж╕ржорзНржкржирзНржи"
}

function Clear-BrowserCache {
    Write-Log "ржмрзНрж░рж╛ржЙржЬрж╛рж░ ржХрзНржпрж╛рж╢ ржкрж░рж┐рж╖рзНржХрж╛рж░ рж╢рзБрж░рзБ..."
    
    $ChromeCache = "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Cache\*"
    Remove-Item -Path $ChromeCache -Recurse -Force -ErrorAction SilentlyContinue
    
    $FirefoxPath = "$env:APPDATA\Mozilla\Firefox\Profiles"
    if (Test-Path $FirefoxPath) {
        Get-ChildItem -Path $FirefoxPath -Directory | ForEach-Object {
            Remove-Item -Path "$($_.FullName)\cache2\*" -Recurse -Force -ErrorAction SilentlyContinue
        }
    }
    
    $EdgeCache = "$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default\Cache\*"
    Remove-Item -Path $EdgeCache -Recurse -Force -ErrorAction SilentlyContinue
    
    Write-Log "ржмрзНрж░рж╛ржЙржЬрж╛рж░ ржХрзНржпрж╛рж╢ ржкрж░рж┐рж╖рзНржХрж╛рж░ рж╕ржорзНржкржирзНржи"
}

function Clear-WindowsUpdateCache {
    Write-Log "Windows Update ржХрзНржпрж╛рж╢ ржкрж░рж┐рж╖рзНржХрж╛рж░ рж╢рзБрж░рзБ..."
    
    Stop-Service -Name wuauserv -Force -ErrorAction SilentlyContinue
    Remove-Item -Path "$env:WINDIR\SoftwareDistribution\Download\*" -Recurse -Force -ErrorAction SilentlyContinue
    Start-Service -Name wuauserv -ErrorAction SilentlyContinue
    
    Write-Log "Windows Update ржХрзНржпрж╛рж╢ ржкрж░рж┐рж╖рзНржХрж╛рж░ рж╕ржорзНржкржирзНржи"
}

function Clear-RecycleBin {
    Write-Log "рж░рж┐рж╕рж╛ржЗржХрзЗрж▓ ржмрж┐ржи ржЦрж╛рж▓рж┐ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..."
    Clear-RecycleBin -Force -ErrorAction SilentlyContinue
    Write-Log "рж░рж┐рж╕рж╛ржЗржХрзЗрж▓ ржмрж┐ржи ржЦрж╛рж▓рж┐ ржХрж░рж╛ рж╕ржорзНржкржирзНржи"
}

function Optimize-Memory {
    Write-Log "ржорзЗржорж░рж┐ ржЕржкржЯрж┐ржорж╛ржЗржЬрзЗрж╢ржи рж╢рзБрж░рзБ..."
    
    $Processes = Get-Process | Where-Object {$_.WorkingSet -gt 100MB}
    foreach ($Process in $Processes) {
        try {
            $Process.Refresh()
        } catch {}
    }
    
    Write-Log "ржорзЗржорж░рж┐ ржЕржкржЯрж┐ржорж╛ржЗржЬрзЗрж╢ржи рж╕ржорзНржкржирзНржи"
}

function Reset-NetworkCache {
    Write-Log "ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржХрзНржпрж╛рж╢ рж░рж┐рж╕рзЗржЯ рж╢рзБрж░рзБ..."
    
    ipconfig /flushdns | Out-Null
    
    Write-Log "ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржХрзНржпрж╛рж╢ рж░рж┐рж╕рзЗржЯ рж╕ржорзНржкржирзНржи"
}

function Reset-WindowsStoreCache {
    Write-Log "Windows Store ржХрзНржпрж╛рж╢ рж░рж┐рж╕рзЗржЯ..."
    Start-Process "wsreset.exe" -WindowStyle Hidden -ErrorAction SilentlyContinue
    Write-Log "Windows Store ржХрзНржпрж╛рж╢ рж░рж┐рж╕рзЗржЯ рж╕ржорзНржкржирзНржи"
}

function Optimize-SSD {
    Write-Log "SSD ржЕржкржЯрж┐ржорж╛ржЗржЬрзЗрж╢ржи (TRIM) рж╢рзБрж░рзБ..."
    
    # рж╕ржм ржбрзНрж░рж╛ржЗржн ржЪрзЗржХ ржХрж░рж╛
    $Drives = Get-PhysicalDisk
    
    foreach ($Drive in $Drives) {
        # SSD ржЪрзЗржХ ржХрж░рж╛
        if ($Drive.MediaType -eq "SSD") {
            Write-Log "SSD ржкрж╛ржУржпрж╝рж╛ ржЧрзЗржЫрзЗ: $($Drive.FriendlyName)"
            
            # TRIM ржХржорж╛ржирзНржб ржЪрж╛рж▓рж╛ржирзЛ
            $Volumes = Get-Partition -DiskNumber $Drive.DeviceId | Get-Volume
            foreach ($Volume in $Volumes) {
                if ($Volume.DriveLetter) {
                    Write-Log "TRIM ржЪрж▓ржЫрзЗ ржбрзНрж░рж╛ржЗржн $($Volume.DriveLetter):\ ржП..."
                    Optimize-Volume -DriveLetter $Volume.DriveLetter -ReTrim -ErrorAction SilentlyContinue
                }
            }
        }
    }
    
    Write-Log "SSD ржЕржкржЯрж┐ржорж╛ржЗржЬрзЗрж╢ржи рж╕ржорзНржкржирзНржи"
}

function Repair-SystemFiles {
    Write-Log "рж╕рж┐рж╕рзНржЯрзЗржо ржлрж╛ржЗрж▓ ржЪрзЗржХ рж╢рзБрж░рзБ..."
    
    Start-Process "DISM" -ArgumentList "/Online /Cleanup-Image /RestoreHealth /Quiet" -WindowStyle Hidden -Wait -ErrorAction SilentlyContinue
    Start-Process "sfc" -ArgumentList "/scannow" -WindowStyle Hidden -Wait -ErrorAction SilentlyContinue
    
    Write-Log "рж╕рж┐рж╕рзНржЯрзЗржо ржлрж╛ржЗрж▓ ржЪрзЗржХ рж╕ржорзНржкржирзНржи"
}

function Check-DiskSpace {
    $Drives = Get-PSDrive -PSProvider FileSystem | Where-Object {$_.Used -gt 0}
    
    foreach ($Drive in $Drives) {
        $FreePercent = [math]::Round(($Drive.Free / ($Drive.Used + $Drive.Free)) * 100, 2)
        
        if ($FreePercent -lt 10) {
            Write-Log "рж╕рждрж░рзНржХрждрж╛: $($Drive.Name) ржбрзНрж░рж╛ржЗржнрзЗ ржорж╛рждрзНрж░ $FreePercent% ржЦрж╛рж▓рж┐ ржЬрж╛ржпрж╝ржЧрж╛ ржЖржЫрзЗ!"
        }
    }
}

function Fix-CommonErrors {
    Write-Log "рж╕рж╛ржзрж╛рж░ржг ржПрж░рж░ ржлрж┐ржХрзНрж╕ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..."
    
    Remove-Item -Path "$env:LOCALAPPDATA\Microsoft\Windows\WER\*" -Recurse -Force -ErrorAction SilentlyContinue
    Remove-Item -Path "$env:ProgramData\Microsoft\Windows Defender\Scans\*" -Recurse -Force -ErrorAction SilentlyContinue
    
    Write-Log "ржПрж░рж░ ржлрж┐ржХрзНрж╕ рж╕ржорзНржкржирзНржи"
}

# ржорзЗржЗржи рж▓рзБржк
Write-Log "=== Laptop Auto Maintenance Service рж╢рзБрж░рзБ рж╣ржпрж╝рзЗржЫрзЗ ==="

$IterationCount = 0

while ($true) {
    try {
        $IterationCount++
        Write-Log "--- Maintenance Cycle #$IterationCount рж╢рзБрж░рзБ ---"
        
        Clear-JunkFiles
        
        if ($IterationCount % 5 -eq 0) {
            Clear-BrowserCache
            Clear-WindowsUpdateCache
            Clear-RecycleBin
            Optimize-Memory
            Reset-NetworkCache
            Fix-CommonErrors
        }
        
        if ($IterationCount % 20 -eq 0) {
            Reset-WindowsStoreCache
            Optimize-SSD
            Repair-SystemFiles
        }
        
        Check-DiskSpace
        
        Write-Log "--- Maintenance Cycle #$IterationCount рж╕ржорзНржкржирзНржи ---"
        
        Start-Sleep -Seconds $CheckInterval
        
    } catch {
        Write-Log "Error: $($_.Exception.Message)"
        Start-Sleep -Seconds 60
    }
}
'@

# ржорзЗржЗржи рж╕рзНржХрзНрж░рж┐ржкрзНржЯ рж╕рзЗржн ржХрж░рж╛
$ServiceScript | Out-File -FilePath $MainScript -Encoding UTF8 -Force
Write-Host "тЬУ ржорзЗржЗржи рж╕рзНржХрзНрж░рж┐ржкрзНржЯ рждрзИрж░рж┐ рж╣ржпрж╝рзЗржЫрзЗ" -ForegroundColor Green

# Step 4: Task Scheduler ржП ржпрзБржХрзНржд ржХрж░рж╛
Write-Host "[4/5] Windows Task Scheduler ржП ржпрзБржХрзНржд ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..." -ForegroundColor Yellow

# ржкрзБрж░рж╛ржирзЛ Task ржорзБржЫрзЗ ржлрзЗрж▓рж╛
try {
    Unregister-ScheduledTask -TaskName "LaptopAutoMaintenance" -Confirm:$false -ErrorAction SilentlyContinue
} catch {}

# ржирждрзБржи Task рждрзИрж░рж┐
$Action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-WindowStyle Hidden -ExecutionPolicy Bypass -File `"$MainScript`""
$Trigger = New-ScheduledTaskTrigger -AtStartup
$Principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
$Settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -RestartCount 3 -RestartInterval (New-TimeSpan -Minutes 1)

try {
    Register-ScheduledTask -TaskName "LaptopAutoMaintenance" -Action $Action -Trigger $Trigger -Principal $Principal -Settings $Settings -Description "Laptop Auto Maintenance Background Service" -Force | Out-Null
    Write-Host "тЬУ Task Scheduler ржП ржпрзБржХрзНржд рж╣ржпрж╝рзЗржЫрзЗ" -ForegroundColor Green
} catch {
    Write-Host "тЪа Task Scheduler ржП ржпрзБржХрзНржд ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛: $_" -ForegroundColor Red
}

# Step 5: ржПржЦржиржЗ Task рж╢рзБрж░рзБ ржХрж░рж╛
Write-Host "[5/5] рж╕рж╛рж░рзНржнрж┐рж╕ рж╢рзБрж░рзБ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..." -ForegroundColor Yellow

try {
    Start-ScheduledTask -TaskName "LaptopAutoMaintenance"
    Write-Host "тЬУ рж╕рж╛рж░рзНржнрж┐рж╕ рж╢рзБрж░рзБ рж╣ржпрж╝рзЗржЫрзЗ" -ForegroundColor Green
} catch {
    Write-Host "тЪа рж╕рж╛рж░рзНржнрж┐рж╕ рж╢рзБрж░рзБ ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛" -ForegroundColor Red
}

# рж╕ржорзНржкржирзНржи ржмрж╛рж░рзНрждрж╛
Write-Host ""
Write-Host "тХФтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХЧ" -ForegroundColor Green
Write-Host "тХС        рж╕рзЗржЯржЖржк рж╕ржорзНржкржирзНржи рж╣ржпрж╝рзЗржЫрзЗ!          тХС" -ForegroundColor Green
Write-Host "тХЪтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХЭ" -ForegroundColor Green
Write-Host ""
Write-Host "тЬУ рж╕рзНржХрзНрж░рж┐ржкрзНржЯ рж▓рзЛржХрзЗрж╢ржи: $MainScript" -ForegroundColor Cyan
Write-Host "тЬУ рж▓ржЧ ржлрж╛ржЗрж▓ рж▓рзЛржХрзЗрж╢ржи: $LogFile" -ForegroundColor Cyan
Write-Host "тЬУ ржкрзНрж░рждрж┐ рзйрзж ржорж┐ржирж┐ржЯ ржкрж░ ржкрж░ ржЕржЯрзЛ ржорзЗржЗржиржЯрзЗржирзЗржирзНрж╕ рж╣ржмрзЗ" -ForegroundColor Cyan
Write-Host "тЬУ Windows рж╕рзНржЯрж╛рж░рзНржЯржЖржкрзЗ ржЕржЯрзЛ рж╢рзБрж░рзБ рж╣ржмрзЗ" -ForegroundColor Cyan
Write-Host "тЬУ ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржбрзЗ ржирзАрж░ржмрзЗ ржХрж╛ржЬ ржХрж░ржмрзЗ" -ForegroundColor Cyan
Write-Host ""
Write-Host "ЁЯУМ ржЯрж┐ржкрж╕:" -ForegroundColor Yellow
Write-Host "   - рж▓ржЧ ржжрзЗржЦрждрзЗ: notepad $LogFile" -ForegroundColor White
Write-Host "   - рж╕рж╛рж░рзНржнрж┐рж╕ ржмржирзНржз ржХрж░рждрзЗ Task Scheduler ржЦрзБрж▓рзЗ 'LaptopAutoMaintenance' ржорзБржЫрзЗ ржжрж┐ржи" -ForegroundColor White
Write-Host "   - рж╕рж╛рж░рзНржнрж┐рж╕ ржЪрж╛рж▓рзБ ржЖржЫрзЗ ржХрж┐ржирж╛ ржжрзЗржЦрждрзЗ: Get-ScheduledTask -TaskName 'LaptopAutoMaintenance'" -ForegroundColor White
Write-Host ""
Write-Host "рзл рж╕рзЗржХрзЗржирзНржб ржкрж░ ржПржЗ ржЙржЗржирзНржбрзЛ ржмржирзНржз рж╣ржмрзЗ..." -ForegroundColor Gray

Start-Sleep -Seconds 5
